/*!build time : 2014-04-20 5:18:09 PM*/
KISSY.add(function(a,b,c){function d(){this._init.apply(this,arguments)}var e=a.DOM,f=a.Event,g="",h={selectedCls:"selected",focusCls:"focus",prefixId:"dropmenu-",prefixCls:"dropmenu-",menuItem:'<li class="{prefixCls}item" id="{prefixId}item{__id}" data-id="{__id}">{text}</li>',empty:"\u641c\u7d22\u65e0\u7ed3\u679c"},i={format:function(a){return a}};return a.augment(d,a.EventTarget,{_init:function(c,d){var f=this,g=a.merge(i,d),j=new b({prefixCls:h.prefixCls});f.layer=j,f.elList=e.create("<ul></ul>"),f.datalist=c,f.format=g.format,j.on("afterRenderUI",function(){f._UIRender()}),this.on("hide",function(){f.focused=void 0})},_UIRender:function(){var b=this,c=b.layer,d=b.elList,e=c.get("el"),f=c.get("contentEl");f.append(d),b._bindList(),b.elWrap=e,b.elWrap.attr("id",h.prefixId+"wrap"+a.guid()),b.fire("UIRender")},emptyRender:function(a){this._list=[],e.html(this.elList,a||h.empty)},render:function(b){var d=this,f=d.lap,h=document.createDocumentFragment();return f&&f.stop(),d.lap?(a.later(function(){d.render(b)},20),!0):(e.html(d.elList,g),f=d.lap=c(b,{duration:30}),d._list=b,f.handle(function(a){var b=d._itemRender(a);b&&h.appendChild(b)}),f.batch(function(){e.append(h,d.elList)}),f.then(function(){e.append(h,d.elList),d.lap=null}),void f.start())},_itemRender:function(b){if(!b)return null;var c=this.format(a.clone(b)),d=a.substitute(h.menuItem,a.merge({prefixId:h.prefixId,prefixCls:h.prefixCls},c)),f=e.create(d),g=this.datalist.getSelectedData();return g&&g.value===b.value&&this._selectByElement(f,b),f},_bindList:function(){var a=this,b=a.elList;f.on(b,"click",function(b){var c=b.target,d=h.prefixCls+"item";if(e.hasClass(c,d)||(c=e.parent(c,d)),c){b.stopPropagation();var f=e.attr(c,"data-id");a.fire("itemSelect",{id:f})}})},select:function(a){var b=this.getElement(a);b||(b=a=void 0),this._selectByElement(b,a),this.fire("select",{data:a})},_focus:function(a){var b=this.getElement(a);b||(b=a=void 0),this._setElementClass(b,this.focused,h.focusCls),this.focused=a,this.scrollIntoView(a),this.fire("focus",{data:a})},_selectByElement:function(a,b){this._setElementClass(a,this.selected,h.selectedCls),this.selected=b,this.focused=b},_setElementClass:function(a,b,c){if(b){var d=this.getElement(b);d&&e.removeClass(d,c)}a&&e.addClass(a,c)},focusNext:function(){var b,c=this.focused;if(c){var d=0;a.each(this._list,function(a,b){return a.value==c.value?(d=b,!1):void 0}),b=this._list[d+1]}else b=this._list[0];this._focus(b)},focusPrevious:function(){var b,c=this.focused;if(c){var d=0;a.each(this._list,function(a,b){return a.value==c.value?(d=b,!1):void 0}),b=this._list[d-1]}else b=this._list[this._list.length-1];this._focus(b)},selectFocused:function(){this.focused&&this.fire("itemSelect",{id:this.datalist.getClientId(this.focused)})},visible:function(a){var b=this.getVisible(),c=void 0===a?!b:a;b!==c&&(c?(this.layer.show(),this.fire("show")):(this.layer.hide(),this.fire("hide")))},getVisible:function(){return this.layer.get("visible")},align:function(a){this.layer.set("align",a)},getElement:function(a){var b=this.datalist.getClientId(a);return b?e.get("#"+h.prefixId+"item"+b,this.elList):void 0},scrollIntoView:function(a){var b=this.getElement(a);e.scrollIntoView(b,this.elWrap)}}),d},{requires:["overlay","gallery/lap/0.1/index"]});